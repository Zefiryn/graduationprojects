<?php

class Application_Model_DbTable_Applications extends Zefir_Application_Model_DbTable
{

	/**
	 * Name of the table without prefix
	 * @var string
	 */
    protected $_raw_name = 'results';
    
     /**
     * Name of the table generated by the constructor
     * @var string
     */
    protected $_name = '';
    
    /**
	 * Primary key of the table
	 * @var string
	 */
    protected $_primary = 'result_id';


    /**
     * An array of child tables information
     * @var array
     */
    protected $_referenceMap = array(
		'Editions' => array(
    		'objProperty' => '_edition',
			'columns' => array('edition_id'),
			'refTableClass' => 'Application_Model_DbTable_Editions',
			'refColumns' => array('edition_id'),
			'onDelete' => self::CASCADE,
			'onUpdate' => self::RESTRICT
		),
		'Degrees' => array(
    		'objProperty' => '_degree',
			'columns' => array('degree_id'),
			'refTableClass' => 'Application_Model_DbTable_Degrees',
			'refColumns' => array('degree_id'),
			'onDelete' => self::CASCADE,
			'onUpdate' => self::RESTRICT
		),
		'WorkTypes' => array(
    		'objProperty' => '_work_type',
			'columns' => array('work_type_id'),
			'refTableClass' => 'Application_Model_DbTable_WorkTypes',
			'refColumns' => array('work_type_id'),
			'onDelete' => self::CASCADE,
			'onUpdate' => self::RESTRICT
		)
	);
	
	/**
	 * An array of parent table information
	 * @var array
	 */
	protected $_dependentTables = array(
		'_files' => 'Application_Model_DbTable_ResultFiles',
	);
	
	/**
	 * constructor
	 * @access public
	 * @param array $config
	 * @return void
	 */
    public function __construct($config = array())
    {
      parent::__construct(array());
    }
    
	/**
     * Save or update application data in the database 
     * 
     * @param Application_Model_Results $result
     * @throws Zend_Exception
     * @return Application_Model_Results $result
     */
	public function save(Application_Model_Results $result)
    {
    		parent::save($application);
    }
    
    public function delete(Application_Model_Applications $application)
    {
		$options = Zend_Registry::get('options');
    	
    	//remove files
    	$this->_deleteApplicationFiles($application->_files);
    	
    	//remove miniature
    	$path = APPLICATION_PATH.'/../public'.$options['upload']['miniatures'].'/'.$application->_miniature;
    	unlink($path);
    	
    	//remove user
    	$application->_user->delete();
    	
    	//remove application
    	parent::delete($application);
    }
    
    protected function _deleteApplicationFiles($files)
    {
    	$options = Zend_Registry::get('options');
    	foreach($files as $file)
    	{
    		$dir = APPLICATION_PATH.'/../public'.$options['upload']['applications'].'/'.substr($file->_path, 0, strrpos($file->_path, '/'));
    		$path = APPLICATION_PATH.'/../public'.$options['upload']['applications'].'/'.$file->_path;
    		//unlink($path);
    		$file->delete();
    	}
    	
    	//rmdir($dir);
    }
}

